# =============================================================================
# CMMC CUI Enclave — Docker Compose Stack
# =============================================================================
# Implements an isolated CUI processing environment for CMMC Level 2 compliance.
#
# Networks:
#   cui-net  (172.20.0.0/24) — isolated CUI environment, NO internet access
#   std-net  (172.19.0.0/24) — standard corporate network segment
#   mgmt-net (172.18.0.0/24) — management plane (audit, monitoring)
#
# Usage:
#   cp .env.example .env && nano .env
#   docker compose up -d
#   docker compose ps
# =============================================================================

version: "3.9"

# ── Networks ──────────────────────────────────────────────────────────────────
networks:
  cui-net:
    driver: bridge
    internal: true          # NO external internet access — critical for CUI isolation
    ipam:
      config:
        - subnet: 172.20.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-cui

  std-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-std

  mgmt-net:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.18.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-mgmt

# ── Volumes ───────────────────────────────────────────────────────────────────
volumes:
  cui-data:
    driver: local
    driver_opts:
      type: none
      o: bind,uid=1000,gid=1000
      device: ${CUI_DATA_PATH:-/opt/cui-enclave/data}

  audit-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${AUDIT_LOG_PATH:-/opt/cui-enclave/logs}

  vpn-config:
    driver: local

# ── Services ──────────────────────────────────────────────────────────────────
services:

  # ---------------------------------------------------------------------------
  # VPN Gateway
  # Provides the ONLY entry point into the CUI enclave.
  # All CUI access must traverse this encrypted tunnel.
  # NIST Controls: SC.3.177 (encryption), AC.1.001 (access control)
  # ---------------------------------------------------------------------------
  vpn-gateway:
    build:
      context: ./docker
      dockerfile: Dockerfile.vpn
    container_name: cui-vpn-gateway
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - PEERS=${VPN_PEERS:-1}
      - SERVERURL=${VPN_SERVER_URL}
      - SERVERPORT=${VPN_PORT:-51820}
      - PEERDNS=${VPN_DNS:-172.20.0.3}
      - INTERNAL_SUBNET=172.20.0.0/24
      - ALLOWEDIPS=172.20.0.0/24
    ports:
      - "${VPN_PORT:-51820}:51820/udp"
    networks:
      cui-net:
        ipv4_address: 172.20.0.2
      std-net:
        ipv4_address: 172.19.0.2
    volumes:
      - vpn-config:/config
    logging:
      driver: syslog
      options:
        syslog-address: "tcp://172.18.0.10:514"
        tag: "cui-vpn"
    labels:
      cmmc.component: "vpn-gateway"
      cmmc.nist-controls: "SC.3.177,AC.1.001,IA.3.083"

  # ---------------------------------------------------------------------------
  # CUI Workstation
  # Hardened Ubuntu container for CUI document processing.
  # No direct internet access — all access via VPN gateway only.
  # NIST Controls: AC.1.001, CM.2.061, SC.3.180
  # ---------------------------------------------------------------------------
  cui-workstation:
    build:
      context: ./docker
      dockerfile: Dockerfile.cui-host
    container_name: cui-workstation
    restart: unless-stopped
    environment:
      - CUI_USER=${CUI_USER:-cuiuser}
      - TZ=${TIMEZONE:-America/New_York}
    networks:
      cui-net:
        ipv4_address: 172.20.0.10
      mgmt-net:
        ipv4_address: 172.18.0.10
    volumes:
      - cui-data:/home/cuiuser/cui-documents:z
      - ./configs/auditd.rules:/etc/audit/rules.d/cmmc.rules:ro
      - ./configs/sysctl.conf:/etc/sysctl.d/99-cmmc.conf:ro
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    read_only: false
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - AUDIT_WRITE
    ulimits:
      nofile:
        soft: 1024
        hard: 4096
    depends_on:
      - vpn-gateway
      - audit-logger
    logging:
      driver: syslog
      options:
        syslog-address: "tcp://172.18.0.10:514"
        tag: "cui-workstation"
    labels:
      cmmc.component: "cui-workstation"
      cmmc.nist-controls: "AC.1.001,CM.2.061,SC.3.180,AU.2.041"

  # ---------------------------------------------------------------------------
  # Audit & Log Aggregator
  # Collects all audit events from enclave components.
  # Logs are write-only from other containers — immutable audit trail.
  # NIST Controls: AU.2.041, AU.2.042, AU.3.045
  # ---------------------------------------------------------------------------
  audit-logger:
    build:
      context: ./docker
      dockerfile: Dockerfile.audit
    container_name: cui-audit-logger
    restart: unless-stopped
    environment:
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-90}
      - SYSLOG_PORT=514
      - TZ=${TIMEZONE:-America/New_York}
    networks:
      mgmt-net:
        ipv4_address: 172.18.0.10
    volumes:
      - audit-logs:/var/log/cui-audit:z
      - ./configs/rsyslog.conf:/etc/rsyslog.d/cmmc.conf:ro
    ports:
      - "127.0.0.1:514:514/tcp"   # Syslog — localhost only
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - SYSLOG
    labels:
      cmmc.component: "audit-logger"
      cmmc.nist-controls: "AU.2.041,AU.2.042,AU.3.045"

  # ---------------------------------------------------------------------------
  # Health Monitor
  # Lightweight container that monitors enclave service health and
  # generates alerts if any component goes offline.
  # NIST Controls: SI.2.214 (security alerts), AU.2.041
  # ---------------------------------------------------------------------------
  health-monitor:
    image: alpine:3.19
    container_name: cui-health-monitor
    restart: unless-stopped
    command: >
      sh -c "while true; do
        echo \"[$(date -u '+%Y-%m-%dT%H:%M:%SZ')] Health check: VPN=$(ping -c1 -W1 172.20.0.2 >/dev/null 2>&1 && echo UP || echo DOWN) WORKSTATION=$(ping -c1 -W1 172.20.0.10 >/dev/null 2>&1 && echo UP || echo DOWN) AUDIT=$(ping -c1 -W1 172.18.0.10 >/dev/null 2>&1 && echo UP || echo DOWN)\";
        sleep 60;
      done"
    networks:
      cui-net:
        ipv4_address: 172.20.0.5
      mgmt-net:
        ipv4_address: 172.18.0.5
    depends_on:
      - vpn-gateway
      - cui-workstation
      - audit-logger
    labels:
      cmmc.component: "health-monitor"
      cmmc.nist-controls: "SI.2.214,AU.2.041"
